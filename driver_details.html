<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Driver Details • Vehicle Safety</title>
    <!-- Load Dashboard CSS first, then Glass Theme (Cinematic) overrides -->
    <link rel="stylesheet" href="/static/css/dashboard.css?v=dropdown_fix_v2">
    <link rel="stylesheet" href="/static/css/glass-theme.css?v=force_white_final" />
    <script src="/static/js/theme-loader.js"></script>

    <!-- Leaflet & Chart Scripts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            margin-top: 20px;
            z-index: 1;
        }

        .video-feed {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .live-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .details-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            /* Updated to use glass var */
        }

        .stat-row:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>

    <!-- Cinematic Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout scroll-section">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/static/img/logo_bw.png" alt="VS" class="logo-icon"
                    style="padding: 0; background: none; border: none; border-radius: 0; filter: invert(1); mix-blend-mode: screen;">
                <span>Vehicle Safety</span>
            </div>

            <nav class="nav-links">
                <a href="/dashboard" class="nav-item">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    Overview
                </a>
                <a href="/drivers" class="nav-item active">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Drivers
                </a>
                <a href="/logs" class="nav-item slide-in-stagger" style="animation-delay: 0.3s">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Logs
                </a>
                <a href="/settings" class="nav-item slide-in-stagger" style="animation-delay: 0.4s">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
                        </path>
                    </svg>
                    Settings
                </a>
            </nav>

            <div class="user-profile">
                <div class="avatar sidebar-avatar">DA</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;" class="sidebar-username">Demo Admin</div>
                    <div style="font-size: 12px; color: var(--text-muted);">View Profile</div>
                </div>
            </div>

            <a href="#" id="sidebarLogoutBtn" class="nav-item danger" style="margin-top: 10px; color: #ef4444;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Logout
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar animate-enter" style="animation-delay: 0.1s">
                <div class="page-title">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <a href="/drivers" class="btn-glass" style="padding: 8px 12px;">← Back</a>
                        <h1 style="margin: 0; font-size: 28px;">Driver #<span id="driverIdDisplay">{{ driver_id
                                }}</span></h1>
                    </div>
                    <p>Live Monitoring & Duty Status</p>
                </div>

                <div class="actions">
                    <button class="btn-glass" onclick="location.reload()">Refresh Data</button>
                    <!-- User Menu Omitted for Brevity -->
                </div>
            </header>

            <div class="details-grid">
                <!-- Left Column: Video & Map -->
                <div style="display: flex; flex-direction: column; gap: 24px;" class="animate-enter"
                    style="animation-delay: 0.2s">
                    <!-- Live Video Feed -->
                    <div class="glass-card" style="padding: 0;">
                        <div class="video-feed">
                            <div class="live-badge">LIVE FEED</div>
                            <div class="live-badge"
                                style="top: 40px; background: rgba(16, 185, 129, 0.9); display: flex; align-items: center; gap: 6px;">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                                Verified Driver
                            </div>
                            <!-- Simulated Video Placeholder -->
                            <div style="text-align: center; color: var(--text-muted);">
                                <svg width="48" height="48" fill="none" stroke="currentColor"
                                    style="opacity: 0.5; margin: 0 auto 10px;" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <div>Connecting to Camera 04...</div>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <h3 style="margin: 0 0 4px 0; font-size: 16px;">Cabin View - vehicle KA-01-A-1234</h3>
                            <div style="font-size: 12px; color: var(--text-muted);">Stream Latency: 45ms • Quality: HD
                            </div>
                        </div>
                    </div>

                    <!-- Map -->
                    <div class="glass-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Live Location & Route</h3>
                            <button id="showRouteBtn" class="btn-glass" style="font-size: 12px; padding: 6px 12px;">Show
                                Planned Route</button>
                        </div>
                        <div id="map" class="map-container"></div>
                    </div>
                </div>

                <!-- Right Column: Stats -->
                <div style="display: flex; flex-direction: column; gap: 24px;" class="animate-enter"
                    style="animation-delay: 0.3s">
                    <!-- Driver Profile Card -->
                    <div class="glass-card">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="{{ driver.photo }}" alt="Driver Photo"
                                style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 12px; border: 3px solid rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                            <h2 style="margin: 0;">{{ driver.name }}</h2>
                            <div style="color: {{ driver.status_color }}; font-size: 14px; margin-top: 4px;">● {{
                                driver.status }}</div>
                            <div
                                style="font-size: 12px; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                <svg width="14" height="14" fill="none" stroke="#34d399" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Face ID Verified (<span id="confidenceId">{{ driver.face_confidence }}</span>%)
                            </div>
                        </div>

                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Vehicle ID</span>
                            <span>{{ driver.vehicle }}</span>
                        </div>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Phone</span>
                            <span>{{ driver.phone }}</span>
                        </div>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">License</span>
                            <span>{{ driver.license }}</span>
                        </div>
                    </div>

                    <!-- Duty Stats -->
                    <div class="glass-card">
                        <h3 style="margin-bottom: 16px;">Duty Summary</h3>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Shift Start</span>
                            <span>{{ driver.shift_start }}</span>
                        </div>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Driving Time</span>
                            <span>{{ driver.drive_time }}</span>
                        </div>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Distance</span>
                            <span>{{ driver.distance }}</span>
                        </div>
                        <div class="stat-row">
                            <span style="color: var(--text-muted);">Safety Score</span>
                            <span style="color: {{ driver.bg_color }}; font-weight: 600;">
                                <span class="count-up" data-target="{{ driver.score }}">0</span>%
                            </span>
                        </div>
                    </div>

                    <!-- Real-time Attention Metrics -->
                    <div class="glass-card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Real-time Metrics</h3>
                            <span
                                style="font-size: 10px; background: rgba(16, 185, 129, 0.15); color: #34d399; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(16, 185, 129, 0.2);">LIVE</span>
                        </div>

                        <div class="stat-row">
                            <div style="display: flex; flex-direction: column;">
                                <span style="color: var(--text-muted); font-size: 13px;">EAR (Eye Aspect Ratio)</span>
                                <span style="font-size: 11px; color: var(--text-muted); opacity: 0.7;">Threshold:
                                    0.25</span>
                            </div>
                            <div style="text-align: right;">
                                <span id="earValue"
                                    style="font-weight: 600; font-family: monospace; font-size: 16px;">{{ driver.ear
                                    }}</span>
                            </div>
                        </div>

                        <div class="stat-row">
                            <div style="display: flex; flex-direction: column;">
                                <span style="color: var(--text-muted); font-size: 13px;">MAR (Mouth Aspect Ratio)</span>
                                <span style="font-size: 11px; color: var(--text-muted); opacity: 0.7;">Threshold:
                                    0.60</span>
                            </div>
                            <div style="text-align: right;">
                                <span id="marValue"
                                    style="font-weight: 600; font-family: monospace; font-size: 16px;">{{ driver.mar
                                    }}</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px; height: 150px;">
                            <canvas id="earMarChart"></canvas>
                        </div>
                    </div>

                    <button class="btn-glass" onclick="openModal('emergencyModal')"
                        style="width: 100%; border-color: #ef4444; color: #ef4444;">Mark
                        Emergency</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Emergency Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <h3 style="color: #ef4444;">Confirm Emergency</h3>
            <p>Are you sure you want to mark this driver as in an emergency state? This will trigger high-priority
                alerts.</p>
            <div class="modal-actions">
                <button class="btn-glass" onclick="closeModal('emergencyModal')">Cancel</button>
                <button class="btn-glass" style="background: #ef4444; border: none;"
                    onclick="closeModal('emergencyModal'); showToast('Emergency declared! Dispatching alert.', 'error')">CONFIRM
                    EMERGENCY</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="/static/js/ui.js?v=persistence_v2"></script>
    <!-- Cinematic Engine Script (Replaces login-3d/theme-loader) -->
    <script src="/static/js/theme-engine.js"></script>

    <script>
        // Init Map
        const map = L.map('map').setView([12.9716, 77.5946], 13); // Bangalore Coords
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '©OpenStreetMap, ©CartoDB'
        }).addTo(map);

        // Simulated Marker Movement
        const marker = L.marker([12.9716, 77.5946]).addTo(map)
            .bindPopup('Current Location')
            .openPopup();

        // Route Logic
        let routePolyline = null;
        document.getElementById('showRouteBtn').addEventListener('click', () => {
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
                document.getElementById('showRouteBtn').innerText = "Show Planned Route";
                return;
            }

            // Simulated Route (Approximate Road Path)
            const latlngs = [
                [12.9784, 77.6408], // Start (Indiranagar)
                [12.9770, 77.6390],
                [12.9750, 77.6360],
                [12.9730, 77.6340], // Turn
                [12.9700, 77.6330],
                [12.9650, 77.6320], // 100 Ft Rd
                [12.9600, 77.6310],
                [12.9550, 77.6300],
                [12.9500, 77.6290], // Domlur Flyover area
                [12.9450, 77.6280],
                [12.9400, 77.6270],
                [12.9352, 77.6245], // End (Koramangala)
                [12.9300, 77.6200]  // Extension
            ];

            // Draw Route
            routePolyline = L.polyline(latlngs, {
                color: '#4f46e5',
                weight: 6,
                opacity: 0.9,
                lineCap: 'round'
            }).addTo(map);

            // Add Markers
            L.circleMarker(latlngs[0], { radius: 8, color: '#10b981', fillOpacity: 1 }).addTo(map).bindPopup("Start");
            L.circleMarker(latlngs[latlngs.length - 1], { radius: 8, color: '#ef4444', fillOpacity: 1 }).addTo(map).bindPopup("Destination");

            map.fitBounds(routePolyline.getBounds());
            document.getElementById('showRouteBtn').innerText = "Hide Route";
        });

        // Logout Logic
        document.getElementById("sidebarLogoutBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            document.body.style.opacity = '0';
            document.body.style.transform = 'scale(0.98)';
            document.body.style.transition = 'all 0.5s ease';
            localStorage.removeItem("vs_token");
            try { await fetch("/logout"); } catch (e) { }
            setTimeout(() => window.location.href = "/", 500);
        });

        // Chart Initialization
        const ctx = document.getElementById('earMarChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    label: 'EAR',
                    data: Array(30).fill(0.32),
                    borderColor: '#10b981', // green
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 0
                }, {
                    label: 'MAR',
                    data: Array(30).fill(0.02),
                    borderColor: '#3b82f6', // blue
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: { color: '#94a3b8' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 0.6,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: { display: false }
                }
            }
        });

        // Simulate Live EAR/MAR Updates
        const earEl = document.getElementById('earValue');
        const marEl = document.getElementById('marValue');

        // Initial parse
        let currentEar = parseFloat(earEl.innerText) || 0.32;
        let currentMar = parseFloat(marEl.innerText) || 0.02;

        setInterval(() => {
            // Small random fluctuation
            // EAR 0.20 - 0.35 (simulated blink/attention)
            // MAR 0.00 - 0.10 (simulated talking/yawning)

            const earDelta = (Math.random() - 0.5) * 0.03;
            const marDelta = (Math.random() - 0.5) * 0.01;

            // Simulate Confidence Fluctuation
            const confEl = document.getElementById('confidenceId');
            if (confEl) {
                let currentConf = parseFloat(confEl.innerText) || 99.2;
                const confDelta = (Math.random() - 0.5) * 0.1;
                let newConf = currentConf + confDelta;
                if (newConf > 99.9) newConf = 99.9;
                if (newConf < 98.0) newConf = 98.0; // Don't drop too low
                confEl.innerText = newConf.toFixed(1);
            }

            currentEar = Math.max(0.18, Math.min(0.38, currentEar + earDelta));
            currentMar = Math.max(0.00, Math.min(0.20, currentMar + marDelta));

            // Format
            earEl.innerText = currentEar.toFixed(2);
            marEl.innerText = currentMar.toFixed(2);

            // Visual Tweaks for Alert States
            if (currentEar < 0.25) {
                earEl.style.color = '#ef4444'; // Red if drowsy
            } else {
                earEl.style.color = ''; // Reset
            }

            if (currentMar > 0.6) {
                marEl.style.color = '#ef4444'; // Red if yawning
            } else {
                marEl.style.color = '';
            }

            // Update Chart
            chart.data.datasets[0].data.push(currentEar);
            chart.data.datasets[1].data.push(currentMar);
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
            chart.update();

        }, 800); // Fast updates
    </script>
    <script src="/static/js/theme-engine.js"></script>
    <script src="/static/js/scroll-engine.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof CinematicEngine !== 'undefined') {
                const engine = new CinematicEngine();
                engine.init();
            }
        });
    </script>
</body>

</html>