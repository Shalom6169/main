<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drivers • Vehicle Safety</title>
    <link rel="stylesheet" href="/static/css/dashboard.css?v=dropdown_fix_v2">
    <link rel="stylesheet" href="/static/css/glass-theme.css?v=force_white_final" />
    <script src="/static/js/theme-loader.js"></script>
</head>

<body>
    <canvas id="bg-canvas"></canvas>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout scroll-section">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/static/img/logo_bw.png" alt="VS" class="logo-icon"
                    style="padding: 0; background: none; border: none; border-radius: 0; filter: invert(1); mix-blend-mode: screen;">
                <span>Vehicle Safety</span>
            </div>

            <nav class="nav-links">
                <a href="/dashboard" class="nav-item">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    Overview
                </a>
                <a href="#" class="nav-item active">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Drivers
                </a>
                <a href="/logs" class="nav-item">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    Logs
                </a>
                <a href="/settings" class="nav-item">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </a>
            </nav>

            <div class="user-profile">
                <div class="avatar sidebar-avatar">DA</div>
                <div>
                    <div style="font-weight: 600; font-size: 14px;" class="sidebar-username">Demo Admin</div>
                    <div style="font-size: 12px; color: var(--text-muted);">View Profile</div>
                </div>
            </div>

            <!-- Explicit Logout Button -->
            <a href="#" class="nav-item danger" style="margin-top: 10px; color: #ef4444;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Logout
            </a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar animate-enter" style="animation-delay: 0.1s">
                <div class="page-title">
                    <h1>Drivers Management</h1>
                    <p>Manage fleet drivers, profiles, and vehicle assignments</p>
                </div>

                <div class="actions" style="display: flex; gap: 16px; align-items: center;">
                    <button class="btn-glass" onclick="location.reload()">Refresh Data</button>

                    <div class="dropdown">
                        <button class="btn-glass" id="userMenuBtn" style="border-color: var(--primary-light);">
                            Account ▼
                        </button>
                        <div class="dropdown-menu" id="userMenu">
                            <a href="#" class="menu-item">Profile</a>
                            <a href="#" class="menu-item">Billing</a>
                            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0;"></div>
                            <a href="#" class="menu-item danger" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Drivers Table -->
            <div class="glass-card animate-enter" style="animation-delay: 0.2s">
                <!-- Card Header -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <h3 style="font-weight: 600; font-size: 18px;">All Drivers</h3>
                        <span
                            style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 12px; color: var(--text-muted); display:flex; gap:4px">
                            Total: <span class="count-up" data-target="24">0</span>
                        </span>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <div class="search-container">
                            <svg class="search-icon" width="16" height="16" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" class="search-input" placeholder="Search by name, vehicle...">
                        </div>
                        <button class="btn-glass" onclick="showToast('Filters applied', 'info')"
                            style="display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                                </path>
                            </svg>
                            Filter
                        </button>
                        <button class="btn-glass" onclick="openModal('addDriverModal')"
                            style="background: var(--primary); border: none; display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Driver
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Driver Name</th>
                                <th>Status</th>
                                <th>Vehicle Details</th>
                                <th>Contact</th>
                                <th>Safety Score</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                            {% for driver in drivers %}
                            <tr onclick="window.location.href='/driver/{{ driver.id }}'" style="cursor: pointer;"
                                class="driver-row" data-name="{{ driver.name|lower }}"
                                data-vehicle="{{ driver.vehicle|lower }}" data-status="{{ driver.status }}">
                                <td>
                                    <div class="driver-info">
                                        <div class="table-avatar" style="background: {{ driver.bg_color }};">{{
                                            driver.name[:2]|upper }}</div>
                                        <div>
                                            <div style="font-weight: 500; color: white;">{{ driver.name }}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">ID: DRV-{{
                                                "%03d"|format(driver.id) }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span
                                        class="badge {% if 'Active' in driver.status %}success{% elif 'Inet' in driver.status %}danger{% else %}warning{% endif %}">
                                        <span
                                            style="width: 6px; height: 6px; background: currentColor; border-radius: 50%;"></span>
                                        {{ driver.status }}
                                    </span>
                                </td>
                                <td>
                                    <div style="font-weight: 500; color: white;">{{ driver.vehicle }}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Details</div>
                                </td>
                                <td>{{ driver.phone }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="color: {{ driver.status_color }}; font-weight: 600;">{{
                                            driver.score }}%</span>
                                        <div
                                            style="width: 60px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;">
                                            <div
                                                style="width: {{ driver.score }}%; height: 100%; background: {{ driver.status_color }}; border-radius: 2px;">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="text-align: right;">
                                    <button class="btn-glass" style="padding: 6px;"
                                        onclick="event.stopPropagation(); openEditModal({{ driver.id }}, '{{ driver.name }}', '{{ driver.vehicle }}', '{{ driver.phone }}')">
                                        <svg width="16" height="16" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                            </path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination-footer">
                    <div>Showing <span style="color: white; font-weight: 600;">1-10</span> of <span
                            style="color: white; font-weight: 600;">24</span> drivers</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="page-btn" disabled>Previous</button>
                        <button class="page-btn"
                            style="background: var(--primary); color: white; border-color: var(--primary);">1</button>
                        <button class="page-btn">2</button>
                        <button class="page-btn">3</button>
                        <button class="page-btn">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Driver Modal -->
    <div class="modal-overlay" id="addDriverModal">
        <div class="modal">
            <h3>Add New Driver</h3>
            <p>Enter the details for the new fleet driver.</p>

            <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                <input type="text" id="addName" placeholder="Full Name" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
                <input type="text" id="addVehicle" placeholder="Vehicle Registration" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
                <input type="text" id="addPhone" placeholder="Phone Number" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
            </div>

            <div class="modal-actions">
                <button class="btn-glass" onclick="closeModal('addDriverModal')">Cancel</button>
                <button class="btn-glass" style="background: var(--primary); border: none;" onclick="saveDriver()">Add
                    Driver</button>
            </div>
        </div>
    </div>

    <!-- Edit Driver Modal -->
    <div class="modal-overlay" id="editDriverModal">
        <div class="modal">
            <h3>Edit Driver</h3>
            <p>Update driver information.</p>
            <input type="hidden" id="editId">

            <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                <input type="text" id="editName" placeholder="Full Name" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
                <input type="text" id="editVehicle" placeholder="Vehicle Registration" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
                <input type="text" id="editPhone" placeholder="Phone Number" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
            </div>

            <div class="modal-actions">
                <button class="btn-glass" onclick="closeModal('editDriverModal')">Cancel</button>
                <button class="btn-glass" style="background: var(--primary); border: none;"
                    onclick="updateDriver()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Scripts -->
    <script src="/static/js/theme-engine.js"></script>
    <script src="/static/js/ui.js?v=persistence_v2"></script>

    <script>
        // Search Functionality
        const searchInput = document.querySelector('.search-input');
        const tableBody = document.getElementById('driversTableBody');
        const rows = tableBody.getElementsByTagName('tr');

        searchInput.addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            for (let row of rows) {
                const name = row.dataset.name || '';
                const vehicle = row.dataset.vehicle || '';
                if (name.includes(term) || vehicle.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Filter Logic (Simple toggles for now)
        function toggleFilter() {
            // In a real app this would show a dropdown. 
            // For now, let's just cycle through: All -> Active -> Inactive
            const currentFilter = document.body.dataset.filter || 'all';
            let nextFilter = 'all';
            if (currentFilter === 'all') nextFilter = 'Active Now';
            else if (currentFilter === 'Active Now') nextFilter = 'Inactive';
            else nextFilter = 'all';

            document.body.dataset.filter = nextFilter;
            showToast(`Filter: ${nextFilter === 'all' ? 'All Drivers' : nextFilter}`);

            for (let row of rows) {
                if (nextFilter === 'all') {
                    row.style.display = '';
                } else {
                    const status = row.dataset.status || '';
                    if (status.includes(nextFilter)) row.style.display = '';
                    else row.style.display = 'none';
                }
            }
        }

        // Attach Filter Function to Button (replacing the toast onclick)
        const filterBtn = document.querySelector('.search-container').nextElementSibling;
        filterBtn.onclick = toggleFilter;


        // Add Driver
        async function saveDriver() {
            const name = document.getElementById('addName').value;
            const vehicle = document.getElementById('addVehicle').value;
            const phone = document.getElementById('addPhone').value;

            if (!name || !vehicle) {
                showToast('Please fill required fields', 'error');
                return;
            }

            try {
                const res = await fetch('/api/drivers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, vehicle, phone })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Driver added successfully', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast('Error adding driver', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Network error', 'error');
            }
        }

        // Edit Driver
        function openEditModal(id, name, vehicle, phone) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editVehicle').value = vehicle;
            document.getElementById('editPhone').value = phone;
            openModal('editDriverModal');
        }

        async function updateDriver() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const vehicle = document.getElementById('editVehicle').value;
            const phone = document.getElementById('editPhone').value;

            try {
                const res = await fetch(`/api/drivers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, vehicle, phone })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Driver updated successfully', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast('Error updating driver', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Network error', 'error');
            }
        }


        (() => {
            // Dropdown Logic
            const dropdownBtn = document.getElementById('userMenuBtn');
            const dropdown = document.querySelector('.dropdown');

            if (dropdownBtn) {
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('active');
                });
            }

            document.addEventListener('click', () => {
                if (dropdown) dropdown.classList.remove('active');
            });

            // Logout Logic (Shared)
            const handleLogout = async (e) => {
                e.preventDefault();

                // Animate exit
                document.body.style.opacity = '0';
                document.body.style.transform = 'scale(0.98)';
                document.body.style.transition = 'all 0.5s ease';

                localStorage.removeItem("vs_token");
                try { await fetch("/logout"); } catch (e) { }

                setTimeout(() => window.location.href = "/", 500);
            };

            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);

            const sidebarLogout = document.getElementById("sidebarLogoutBtn");
            if (sidebarLogout) sidebarLogout.addEventListener("click", handleLogout);

        })();
    </script>
    <script src="/static/js/theme-engine.js"></script>
    <script src="/static/js/scroll-engine.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof CinematicEngine !== 'undefined') {
                const engine = new CinematicEngine();
                engine.init();
            }
        });
    </script>
</body>

</html>